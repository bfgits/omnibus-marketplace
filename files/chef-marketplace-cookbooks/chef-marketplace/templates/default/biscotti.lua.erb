<% unless node['chef-marketplace']['role'] == 'compliance' %>
-- When the http_x_ops_userid header is set we route it to the chef-server API.
-- We only need to require authentication for the UI so we'll move on if that
-- header is present.
if ngx.var.http_x_ops_userid then
    return
end
<% end %>

-- Whitelist all requests to the biscotti upstream.  This allows us to download
-- biscotti assets without a cookie being present.
if ngx.re.match(ngx.var.uri,  "^/biscotti") then
    return
end

local cookie = ngx.var.cookie_ChefMarketplaceAuth

if cookie ~= nil then
    -- Check if the HMAC in the cookie matches what we expect
    local token_hmac = '<%= @token_hmac %>'
    if token_hmac == cookie then
        return
    end
end

-- If we don't get a match then route to biscotti
ngx.exec("/biscotti")
