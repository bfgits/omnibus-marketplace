-- We only need to require authentication for the web ui so we'll proxy to the
-- chef-server api when the chef-client makes requests
if ngx.var.http_x_ops_userid then
    return
end

local sha1 = require('sha1')
local cookie = ngx.var.cookie_ChefMarketplaceAuth

if cookie ~= nil then
  -- Check if the HMAC in the cookie matches what we expect
  if sha1.hmac("<%= node['chef-marketplace']['biscotti']['token'] %>", "<%= node['chef-marketplace']['biscotti']['uuid'] %>") == cookie then
        return
    end
end

-- If we don't get a match then route to biscotti
ngx.exec("/biscotti")
